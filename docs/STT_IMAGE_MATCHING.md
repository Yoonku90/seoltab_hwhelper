# STT 데이터를 통한 이미지 특정 방식

## 현재 상황

### ❌ STT 데이터만으로는 이미지를 직접 특정하기 어려움

현재 STT 데이터 구조를 분석한 결과:

1. **STT 데이터 필드**:
   - `speaker`: 화자 (teacher/student)
   - `text`: 대화 내용
   - `timestamp`: 시간 정보
   - `order_idx` / `index`: 순서 정보

2. **이미지 참조 필드 없음**:
   - STT 데이터에는 `image_url`, `imageUrl`, `image` 같은 이미지 참조 필드가 **없습니다**
   - 현재 코드에서 추출을 시도하고 있지만, 실제로는 `null`이 반환됩니다

### 현재 구현 방식

```typescript
// STT에서 이미지 참조 추출 시도 (하지만 실제로는 거의 항상 null)
const imageRef = conv.image_url || conv.imageUrl || conv.image || null;

// 결과: sttImageRefs.length는 거의 항상 0
// 따라서 모든 이미지를 가져와서 사용
images = allImages; // STT 참조 없음, 전체 사용
```

## 가능한 이미지 특정 방식

### 1. ⏰ 타임스탬프 기반 매칭 (현재 불가능)

**방식**: STT의 `timestamp`와 이미지 업로드 시간을 비교

**문제점**:
- STT 타임스탬프와 이미지 업로드 시간이 정확히 일치하지 않을 수 있음
- 이미지가 언제 업로드되었는지 확인하는 API가 필요
- Room ID로 가져온 이미지들은 시간 정보가 없을 수 있음

**구현 필요사항**:
```typescript
// Pagecall API에서 이미지 업로드 시간 정보 필요
// 현재는 이미지 URL만 제공, 타임스탬프 없음
```

### 2. 📝 텍스트 분석 기반 추론 (가능)

**방식**: STT 텍스트 내용을 분석하여 어떤 이미지가 논의되었는지 추론

**예시**:
- "이 표를 보면..." → 표가 있는 이미지
- "1번 문제..." → 1번 문제가 있는 이미지
- "그래프에서..." → 그래프가 있는 이미지

**구현 방법**:
```typescript
// Gemini API를 사용하여 STT 텍스트와 이미지 OCR 텍스트를 비교
// 유사도가 높은 이미지를 선택
```

**장점**:
- 실제 수업 내용과 관련된 이미지만 선택 가능
- STT 텍스트만으로도 충분히 가능

**단점**:
- 추가 API 호출 필요 (OCR + Gemini 분석)
- 처리 시간 증가
- 비용 증가

### 3. 🔢 순서 기반 추론 (부분 가능)

**방식**: STT 대화 순서와 이미지 업로드 순서를 매칭

**예시**:
- 첫 번째 대화 → 첫 번째 이미지
- 두 번째 대화 → 두 번째 이미지

**문제점**:
- 이미지 업로드 순서를 알 수 없음 (Pagecall API는 순서 보장 안 함)
- STT 순서와 이미지 순서가 일치하지 않을 수 있음

### 4. 🎯 키워드 매칭 (가능하지만 부정확)

**방식**: STT 텍스트에서 문제 번호, 페이지 번호 등을 추출하여 이미지와 매칭

**예시**:
- "1번 문제" → 이미지에서 1번 문제 찾기
- "2페이지" → 2페이지 이미지

**구현 필요사항**:
```typescript
// STT 텍스트에서 숫자 추출
const problemNumbers = sttText.match(/(\d+)번/gi);
const pageNumbers = sttText.match(/(\d+)페이지/gi);

// 이미지 OCR에서 문제 번호/페이지 번호 찾기
// 매칭되는 이미지 선택
```

**단점**:
- 정확도가 낮음
- 문제 번호가 중복될 수 있음

## 권장 방안

### ✅ 현재 방식 (전체 이미지 사용)

**장점**:
- 구현이 간단
- 모든 이미지가 요약본에 포함됨
- 빠른 처리

**단점**:
- 불필요한 이미지도 포함될 수 있음
- 실제 수업에서 사용된 이미지만 선택 불가

### 🔮 향후 개선 방안

1. **Gemini Vision API 활용**:
   - STT 텍스트를 프롬프트로 사용
   - 각 이미지를 분석하여 STT 내용과 관련성 점수 계산
   - 점수가 높은 이미지만 선택

2. **Pagecall API 개선 요청**:
   - 이미지 업로드 타임스탬프 추가
   - STT와 이미지 연결 정보 제공

3. **하이브리드 방식**:
   - 타임스탬프가 있으면 타임스탬프 기반
   - 없으면 텍스트 분석 기반
   - 둘 다 없으면 전체 이미지 사용 (현재 방식)

## 결론

**STT 데이터만으로는 이미지를 직접 특정할 수 없습니다.**

현재는:
- ✅ Room ID로 모든 이미지를 가져와서 사용
- ✅ STT 순서는 저장하되, 이미지는 전체 사용

향후 개선을 위해서는:
- 🔮 Gemini API를 활용한 텍스트-이미지 관련성 분석
- 🔮 Pagecall API에서 추가 메타데이터 제공
- 🔮 타임스탬프 기반 매칭 (API 개선 시)

