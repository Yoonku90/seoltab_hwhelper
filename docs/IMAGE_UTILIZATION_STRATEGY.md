# 이미지 적극 활용 전략

## 현재 상황

**문제점:**
- 그래프, 수식, 도형, 표 등의 시각적 요소를 채팅으로 설명하기 어려움
- 이미지가 있지만 AI가 명시적으로 참조하지 않음
- 학생이 "이 그래프" 같은 질문을 할 때 정확히 무엇을 가리키는지 애매함

## 활용 방안

### 1. 이미지 영역 참조 (명시적 참조) ⭐

**개념:**
AI가 이미지의 특정 부분을 명시적으로 참조하여 설명

**구현:**
```typescript
// AI 응답 예시
{
  "message": "이미지의 3번 문제를 보면, 항등식 문제야. 
              식 $ax + b = 0$에서 $a = 0$이고 $b = 0$이어야 해.",
  "imageReference": {
    "problemNumber": 3,
    "description": "3번 문제 영역"
  }
}
```

**프롬프트 수정:**
```
- 이미지가 있으면, 설명할 때 이미지의 특정 부분을 명시적으로 참조해줘
- 예: "이미지의 3번 문제를 보면...", "그래프의 x축을 보면...", "표의 2번째 행을 보면..."
- 문제 번호가 있으면 "N번 문제"처럼 명시적으로 언급
```

**장점:**
- 학생이 정확히 무엇을 봐야 하는지 알 수 있음
- 그래프, 도형, 표 등을 설명할 때 매우 유용
- 구현이 간단함

**단점:**
- 이미지를 명시적으로 언급해야 함 (자연스러움 약간 떨어질 수 있음)

### 2. 이미지 하이라이트 (시각적 강조) ⭐⭐

**개념:**
특정 문제/영역을 시각적으로 강조 (박스, 하이라이트)

**구현:**
```typescript
// AI 응답에 좌표 정보 포함
{
  "message": "이 문제는 항등식 문제야...",
  "highlightRegion": {
    "x": 0.2,  // 이미지에서의 비율 (0-1)
    "y": 0.5,
    "width": 0.6,
    "height": 0.2,
    "problemNumber": 3
  }
}
```

**UI 변경:**
```tsx
// 이미지 위에 하이라이트 박스 오버레이
<div className={styles.imageContainer}>
  <img src={imageUrl} />
  {highlightRegion && (
    <div 
      className={styles.highlightBox}
      style={{
        left: `${highlightRegion.x * 100}%`,
        top: `${highlightRegion.y * 100}%`,
        width: `${highlightRegion.width * 100}%`,
        height: `${highlightRegion.height * 100}%`,
      }}
    />
  )}
</div>
```

**프롬프트 수정:**
```
- 문제를 설명할 때, 해당 문제의 position 정보를 활용해줘
- position: { x, y, width, height } (이미지에서의 비율 0-1)
- JSON 응답에 highlightRegion 필드 추가
```

**장점:**
- 학생이 정확히 무엇을 봐야 하는지 시각적으로 명확
- 그래프, 도형, 표 등을 설명할 때 매우 효과적
- 직관적이고 이해하기 쉬움

**단점:**
- UI 변경 필요 (오버레이 구현)
- 좌표 정보가 정확해야 함

### 3. 이미지 일부 크롭 (문제별 이미지) ⭐⭐

**개념:**
문제별로 이미지의 해당 부분만 추출하여 보여주기

**구현:**
```typescript
// 서버에서 이미지 크롭
import sharp from 'sharp';

async function cropProblemImage(
  imageBuffer: Buffer,
  position: { x: number; y: number; width: number; height: number },
  imageWidth: number,
  imageHeight: number
): Promise<Buffer> {
  const x = Math.floor(position.x * imageWidth);
  const y = Math.floor(position.y * imageHeight);
  const width = Math.floor(position.width * imageWidth);
  const height = Math.floor(position.height * imageHeight);
  
  return await sharp(imageBuffer)
    .extract({ left: x, top: y, width, height })
    .toBuffer();
}
```

**사용 시나리오:**
- 특정 문제를 설명할 때 해당 문제 영역만 크롭해서 보여주기
- 채팅 메시지에 작은 이미지 삽입

**장점:**
- 학생이 정확히 해당 부분만 볼 수 있음
- 채팅 메시지와 함께 표시 가능
- 매우 직관적

**단점:**
- 이미지 처리 라이브러리 필요 (sharp 등)
- 서버 리소스 사용 (크롭 처리)
- 구현 난이도 높음

### 4. 좌표 기반 설명 (Position 활용) ⭐

**개념:**
이미지 분석 시 얻은 position 정보를 활용하여 설명

**현재 상태:**
```typescript
// 이미지 분석 시 position 정보 저장됨
{
  "recognizedProblems": [
    {
      "number": 3,
      "text": "...",
      "position": {
        "x": 0.2,
        "y": 0.5,
        "width": 0.6,
        "height": 0.2
      }
    }
  ]
}
```

**활용 방법:**
- AI가 특정 문제를 설명할 때 position 정보를 함께 전달
- 프롬프트에 position 정보 포함:
  ```
  [현재 설명 중인 문제]
  문제 번호: 3
  위치: 이미지의 왼쪽에서 20%, 위에서 50% 지점에 있는 영역 (가로 60%, 세로 20%)
  내용: ...
  
  → 이 정보를 바탕으로 "이미지의 왼쪽 상단에 있는 3번 문제"처럼 자연스럽게 설명
  ```

**장점:**
- 이미 저장된 정보 활용
- 구현 난이도 낮음
- 자연스러운 설명 가능

**단점:**
- 시각적 피드백 없음 (텍스트 설명만)

### 5. 이미지 주석 오버레이 (고급) ⭐⭐⭐

**개념:**
이미지 위에 설명, 화살표, 박스 등을 직접 그리기

**구현:**
```tsx
// Canvas를 사용한 오버레이
<canvas 
  ref={overlayCanvas}
  style={{
    position: 'absolute',
    top: 0,
    left: 0,
    width: '100%',
    height: '100%',
  }}
/>
```

**사용 시나리오:**
- 그래프의 특정 점을 화살표로 가리키기
- 수식의 특정 부분을 강조
- 표의 특정 셀을 박스로 표시

**장점:**
- 매우 직관적이고 명확
- 복잡한 시각적 설명 가능

**단점:**
- 구현 난이도 매우 높음
- Canvas/SVG 조작 필요
- AI가 좌표를 정확히 계산해야 함

## 권장 구현 순서

### Phase 1: 명시적 참조 (즉시 구현 가능) ⭐

**구현:**
1. 프롬프트 수정: "이미지의 N번 문제를 보면..." 같은 명시적 참조 추가
2. AI 응답에 문제 번호 포함
3. UI 변경 없음 (텍스트만으로도 충분)

**예시:**
```
AI: "이미지의 3번 문제를 보면, 항등식 문제야. 
     식 $ax + b = 0$에서 $a = 0$이고 $b = 0$이어야 해."
```

**효과:**
- 학생이 정확히 무엇을 봐야 하는지 알 수 있음
- 그래프, 도형, 표 등을 설명할 때 매우 유용
- 구현 난이도: 낮음

### Phase 2: 이미지 하이라이트 (중기)

**구현:**
1. AI 응답에 `highlightRegion` 필드 추가
2. 이미지 위에 하이라이트 박스 오버레이 구현
3. position 정보를 활용하여 박스 표시

**효과:**
- 시각적으로 매우 명확
- 학생이 정확히 무엇을 봐야 하는지 한눈에 알 수 있음

**구현 난이도:**
- 중간 (CSS positioning + 좌표 계산)

### Phase 3: 이미지 크롭 (선택적)

**구현:**
1. `sharp` 라이브러리 설치
2. 문제별 이미지 크롭 API 생성
3. 채팅 메시지에 작은 이미지 삽입

**효과:**
- 매우 직관적
- 채팅과 함께 이미지 표시

**구현 난이도:**
- 높음 (이미지 처리 라이브러리 필요)

## 즉시 적용 가능한 방법 (Phase 1)

### 1. 프롬프트 수정

**튜터 API 프롬프트에 추가:**
```
(매우 중요) 이미지 참조 규칙:
- 이미지가 있으면, 설명할 때 이미지의 특정 부분을 명시적으로 참조해줘
- 문제 번호가 있으면: "이미지의 N번 문제를 보면...", "N번 문제의 그래프를 보면..."
- 그래프가 있으면: "이미지의 그래프를 보면...", "x축을 보면...", "y축을 보면..."
- 표가 있으면: "이미지의 표를 보면...", "2번째 행을 보면...", "3번째 열을 보면..."
- 도형이 있으면: "이미지의 삼각형을 보면...", "직선을 보면..."
- 자연스럽게 설명하되, 학생이 정확히 무엇을 봐야 하는지 명확하게 해줘
```

### 2. 컨텍스트에 position 정보 포함

**현재:**
```
[현재 풀고 있는 문제] (idx=0)
"항등식 문제..."
```

**개선:**
```
[현재 풀고 있는 문제] (idx=0)
문제 번호: 3
위치: 이미지의 왼쪽에서 20%, 위에서 50% 지점 (가로 60%, 세로 20%)
"항등식 문제..."

→ "이미지의 3번 문제를 보면..." 같은 설명 생성
```

## 결론

**즉시 적용 가능 (Phase 1):**
- AI가 이미지를 명시적으로 참조하도록 프롬프트 수정
- "이미지의 N번 문제를 보면..." 같은 표현 사용
- 구현 난이도: 낮음, 효과: 높음

**중기 개선 (Phase 2):**
- 이미지 하이라이트 기능 추가
- 시각적으로 매우 명확
- 구현 난이도: 중간

**장기 개선 (Phase 3):**
- 이미지 크롭 기능
- 매우 직관적
- 구현 난이도: 높음

**권장: Phase 1부터 시작!**

